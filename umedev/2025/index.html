<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Make Migrations Great Again</title>

    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/moon.css" id="theme">
    <link rel="stylesheet" href="plugin/highlight/windows-95.css">
</head>

<body>

    <div class="reveal">

        <div class="slides">
            <section data-markdown data-transition="convex" data-separator-vertical="^--$">
                <script type="text/template">
                    # Make Database Migrations Great Again

                    ---

                    ## Om mig
                    ```json [2|3]
                    {
                        "Namn": "Ragnar Eklund"
                        "Arbete": "Visionite / Skatteverket"
                        "Favoritspr√•k": [object Object]
                    }
                    ```
                    ---
                    ## Vad g√∂r jag h√§r?
                    notes: Jag √§r h√§r f√∂r att dela med mig av erfarenheter kring databasmigreringar i `Java` ‚òïÔ∏è.

                    ---

                    ## Bakgrund
                    `üíé` <!-- .element: class="fragment fade-up" --> `üêç` <!-- .element: class="fragment fade-up" --> `‚òïÔ∏è` <!-- .element: class="fragment fade-up" -->
                    notes: Jag har jobbat i projekt med b√•de Ruby on Rails och Django Python
                           Suttit med `Java` sen 2008 och de senaste fem √•ren dagligen
                    
                    ---
                    ### Vad √§r en databasmigrering?
                    --
                    En beskrivning hur du tar en databas fr√•n ett tillst√•nd till ett annat
                    <!-- .element: style="font-family: monospace" -->
                    --
                    ## Varf√∂r ska man ha datbasmigreringar?

                    notes:
                    * Ger en f√∂rutbest√§md struktur p√• ens databas
                    * Man kan f√∂lja f√∂r√§ndringar i databasstrukturen
                    * Databasmodellen kan h√•llas i synk med kod√§ndringar i ens versionshantering
                    --
                    ## Exempel
                    L√§gg till en kolumn i tabellen `Books`
                    ```markdown [1-4|1-5]
                    |Column   |Type   |
                    |---------|-------|
                    |BookTitle|VARCHAR|
                    |Author   |VARCHAR|
                    |Pages    |INTEGER|
                    ```
                    --
                    ### L√•t oss titta n√§rmare p√• hur man g√∂r i 
                    ### python üêç och ruby üíé
                    ---
                    <!-- .slide: data-auto-animate -->
                    ### Python üêç och Django
                    ```python [1-3]
                    class Book(models.Model):
                        book_title = models.CharField(max_length=50)
                        author     = models.CharField(max_length=50)
                    ```
                    <!-- .element: data-id="python-pages" class="fragment fade-up" -->
                    --
                    <!-- .slide: data-auto-animate -->
                    ### Python üêç och Django
                    ```python [4]
                    class Book(models.Model):
                        book_title = models.CharField(max_length=50)
                        author     = models.CharField(max_length=50)
                        pages      = models.IntegerField()
                    ```
                    <!-- .element: data-id="python-pages" -->
                    --
                    <!-- .slide: data-auto-animate -->
                    ### Identifiera f√∂r√§ndringen ...
                    ```bash []
                    $ python manage.py makemigrations
                    ```
                    <!-- .element: data-id="python-make-migrations-animation" -->
                    --
                    <!-- .slide: data-auto-animate -->
                    ### ... och generera en migrering
                    ```bash [2-4]
                    $ python manage.py makemigrations
                    Migrations for 'books':
                    books/migrations/0002_books.py:
                        ~ Alter field pages on books
                    ```
                    <!-- .element: data-id="python-make-migrations-animation" -->
                    --
                    ### Resultatet
                    ```python []
                    # books/migrations/0002_books.py
                    class Migration(migrations.Migration):
                        dependencies = [ ("migrations", "0001_initial") ]
                        operations   = [ migrations.AddField("Books", "Pages") ]
                    ```
                    --
                    ## Ruby üíé och Rails üõ§
                    --
                    ### Lite annorlunda approach
                    F√§lt i modeller genereras utifr√•n kolumner i databasen
                    ```ruby
                    # Tom klass som √§rver av ApplicationRecord.
                    class Book < ApplicationRecord
                    end
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    --
                    <!-- .slide: data-auto-animate -->
                    ### Generera en migrering
                    ```bash []
                    $ rails generate migration AddPagesToBooks pages:number
                    ```
                    <!-- .element: data-id="rails-make-migrations-animation" -->
                    --
                    <!-- .slide: data-auto-animate -->
                    ### Generera en migrering
                    ```ruby []
                    # rails generate migration AddPagesToBooks pages:number
                    class AddPagesToBooks < ActiveRecord::Migration
                      def change
                        add_column :books, :pages, :number
                      end
                    end
                    ```
                    <!-- .element: data-id="rails-make-migrations-animation" -->
                    --
                    ## Java ‚òïÔ∏è och Flyway
                    Ingen av de stora javaramverken som `Spring Boot` har egna migreringsverktyg, utan f√∂rlitar sig p√• tredjepartsverktyg som `Flyway`
                    --
                    ### Flyway
                    Anv√§nder sig fr√§mst av vanlig `SQL` och namnkonventioner f√∂r filnamn
                    ```bash
                    $ ls src/main/java/resources/db/migrations
                    V1.0__init.sql
                    V1.1__addPagesToBooks.sql
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    ```sql
                    -- V1.1__addPagesToBooks.sql
                    ALTER TABLE Books
                    ADD COLUMN Pages INTEGER
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    --
                    ### Generera migreringar...

                    ```bash
                    $ ???
                    ```
                    <!-- .element: class="fragment fade-up" -->                    
                    ## Oh Noes! ü§¨ <!-- .element: class="fragment fade-up" -->
                    
                    notes: 
                    * Till skillnad fr√•n rails och django s√• kan Flyway inte generera migreringar.
                    * Anledningen till det √§r f√∂r att Flyway inte har koll p√• dina datamodeller.
                    
                    ---
                    
                    ## Hur l√∂ser vi det?
                    Vi beh√∂ver n√•got som kan tolka javamodeller och koppla ihop de med databasen ü§î <!-- .element: class="fragment fade-up" -->
                    --
                    ## JPA + Hibernate
                    --
                    ## JPA
                    Jakarta Persistance (tidigare **J**ava **P**ersistance **A**PI)
                    notes: `JPA` l√•ter dig beskriva hur datamodeller i `Java` ska √∂vers√§ttas till databasmodeller
                    --
                    ## JPA Exempel
                    ```java [1-11|1,3,6,9]
                    @Entity
                    public class Book {
                        @Id
                        String isbn;
                        
                        @Column(name = "bookTitle")
                        String title;

                        @Column(name = "author")
                        String authors;
                    }
                    ```
                    ---
                    ## Hibernate
                    En implementation av `JPA`

                    √Ñven k√§nt som "Object-Relational Mapping" eller ORM <!-- .element: class="fragment fade-up" data-fragment-index="1" -->
                    --
                    ## Hibernate
                    * Klistret mellan kod och databas  <!-- .element: class="fragment fade-up" data-fragment-index="1" -->
                    * M√∂jlighet att generera <!-- .element: class="fragment fade-up" data-fragment-index="2" --> `SQL` fr√•n `JPA-modeller` <!-- .element: class="fragment fade-up" data-fragment-index="2" -->

                    ü•≥<!-- .element: class="fragment fade-up" data-fragment-index="3" -->
                    --

                    `Spring Boot` visar sig ha m√∂jlighet att l√§tt anv√§nda sig av det:

                    ```yaml
                    # src/main/resources/application.yaml
                    spring:
                      jpa:
                        hibernate:
                          ddl-auto: update
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    
                    --
                    ## Problematiskt
                    notes: 
                    * Det h√§r √§r varken n√•got som du eller skaparna av Spring vill att du anv√§nder dig av i produkton...
                    * Du f√•r inte med √§ndringarna i versionshistoriken
                    * Okej i lokala test men problematiskt om man k√∂r det mot gemensamma testdatabaser
                    --
                    Vi beh√∂ver en lokal milj√∂ att k√∂ra migreringar mot
                    --
                    ## H2
                    En snabb <!-- .element: class="fragment fade-up" data-fragment-index="1" --> `in-memory` databas som kan hantera v√§ldigt m√•nga olika SQL-dialekter <!-- .element: class="fragment fade-up" data-fragment-index="1" -->

                    Perfekt f√∂r test! ‚ú® <!-- .element: class="fragment fade-up" data-fragment-index="1" -->
                    ---

                    ## Dags att pussla üß©
                    ### Flyway + Hibernate + H2 <!-- .element: class="fragment fade-up" -->

                    notes:
                    - üß© Vi har m√∂jlighet att k√∂ra existerande migreringar f√∂r att f√• databasen i ett produktionsliknande l√§ge
                    - üß© Hibernate DDL-Update skapar en SQL som beskriver skillnaden mellan dina JPA-modeller och din databas
                    - üß© Vi kan k√∂ra de i H2 f√∂r att h√•lla allt lokalt
                    --
                    ### Paketera det hela som ett testbibliotek üì¶
                    --
                    ## Vad l√∂ser vi med det?
                    notes:
                    * Man kan skriva ett enkelt test som kollar om JPA-modellerna st√§mmer √∂verens med databasen
                    * Om testet misslyckas s√• f√•r man f√∂rslag p√• l√§mplig migrering
                    * Det p√•verkar inga externa system
                    --
                    <!-- .slide: data-auto-animate -->
                    ## Resultatet
                    
                    ```java [6: 2-5|7]
                    @Test
                    void testMigration() {
                        var result = Migration.configure()
                                .includePackages("adapter.database.models.jpa")
                                .test();

                        assertThat(result).isEmpty();
                    }
                    ```
                    <!-- .element: data-id="migration-test" class="fragment fade-up" -->
                    --
                    <!-- .slide: data-auto-animate -->
                    ## Resultatet

                    ```java [6: 11-15]
                    @Test
                    void testMigration() {
                        var result = Migration.configure()
                                .includePackages("adapter.database.models.jpa")
                                .test();

                        assertThat(result).isEmpty();
                    }

                    /*
                    java.lang.AssertionError: 
                    Expecting empty but was:

                    ALTER TABLE Books 
                    ADD COLUMN Pages INTEGER;
                    */
                    ```
                    <!-- .element: data-id="migration-test" -->
                    --
                    ### N√•gra intressanta konsekvenser
                    ```sql [1-4|2]
                    ALTER TABLE IF EXISTS Book
                    ADD CONSTRAINT FKs2s22xi4nya4ukpsvw6luwcl8
                    FOREIGN key (collection_id)
                    REFERENCES BookCollection;
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    ```java [6:1-12|7-10]
                    @Entity
                    public class BookCollection {
                        @Id
                        String id;

                        @OneToMany
                        @JoinColumn(
                            name = "collection_id", 
                            foreignKey = @ForeignKey(
                                name = "book_collection_fk"))
                        List<Book> books;
                    }
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    notes:
                    * Man uppt√§cker skillnader mellan JPA-modellerna och databasen
                    * Fr√§mst √§r det att JPA inte har koll p√• ens namngivna index utan f√∂resl√•r slumpade
                    ---
                    ## Utmaningar
                    --
                    ### Navigera i Hibernates API:er
                    ```java [85:1-11|2]
                    var target = new StringWriter();
                    SchemaManagementToolCoordinator.process(
                        metadata.buildMetadata(),
                        serviceRegistry,
                        Map.ofEntries(
                                entry(JAKARTA_HBM2DDL_SCRIPTS_ACTION, Action.UPDATE.getExternalHbm2ddlName()),
                                entry(JAKARTA_HBM2DDL_SCRIPTS_CREATE_TARGET, target),
                                entry(UNIQUE_CONSTRAINT_SCHEMA_UPDATE_STRATEGY, UniqueConstraintSchemaUpdateStrategy.SKIP),
                                entry(SHOW_SQL, true),
                                entry(FORMAT_SQL, true)),
                        action -> {});
                    ```
                    <!-- .element: class="fragment fade-up" -->
                    --
                    ### SQL-dialekter
                    notes:
                    * F√∂rslagen som genereras beh√∂ver vara anpassade efter den databasen som anv√§nds men testerna k√∂rs i H2.
                    * Hibernate har st√∂d f√∂r √∂ver ett 10-tal olika databaser och tillh√∂rande dialekter.
                    * H2 St√∂der m√•nga med inte alla och inte alla quirks.
                    * Eget interface f√∂r dialekter.
                    --
                    ### Constraints
                    notes:
                    * H2 slumpar fram namn p√• index genererade fr√•n constraints (uniqe) vilket g√∂r att Hibernate inte hittar de och testerna g√•r inte igenom.
                    --
                    ### Delete / Rename
                    notes:
                    * Inget st√∂d f√∂r att ta bort eller d√∂pa om tabeller eller kolumner. Mer en feature √§n utmaning.
                    * Designbeslut fr√•n g√§nget bakom hibernate
                    ---
                    # Framtiden
                    notes:
                    * Open source
                    * L√§gga till dialekter
                    ---
                    # Fr√•gor?
                </script>
            </section>
        </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/math/math.js"></script>

    <script>

        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,
            slideNumber: true,

            plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath.KaTeX]
        });

    </script>

</body>

</html>